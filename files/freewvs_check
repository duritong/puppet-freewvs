#!/usr/bin/env ruby

require 'erb'
require 'yaml'

load "/etc/freewvs/freewvs_check.conf"

db_file = "/var/local/freewvs_check.db"

if File.exists?(db_file)
  db = YAML::load(File.read(db_file))
else
  db = {}
end


DIR = File.dirname(__FILE__)

result = `#{DIR}/freewvs/freewvs -x /var/www/`
entries = {}

begin
  result =~ /<app state="vulnerable">(.+?)<\/app>(.*)/m
  entry  = $1
  result = $2
  entry  =~ /<directory>(.+)<\/directory>/
  dir    = $1
  host   = dir.split("/")[4]
  dir   = dir.split("/")[5..-1].join("/")
  entries[host]    ||= {}
  entries[host][dir] = {}
  entry  =~ /<appname>(.+)<\/appname>/
  entries[host][dir][:app] = $1
  entry  =~ /<version>(.+)<\/version>/
  entries[host][dir][:version] = $1
  entry  =~ /<safeversion>(.+)<\/safeversion>/
  entries[host][dir][:safe_version] = $1
  entry  =~ /<vulninfo>(.+)<\/vulninfo>/
  entries[host][dir][:cve] = $1
end while result =~ /<app/

template = File.read('/etc/freewvs/freewvs_check.erb')

entries.each do |host,folders|
  if db[host]
    if (db[host][:lastreport] && Time.now - db[host][:lastreport] < REPORT_TIME) &&
       (db[host][:reportsize] && db[host][:reportsize] == folders.size)
      next
    end
  end

  db[host] ||= {}
  db[host][:lastreport] = Time.now
  db[host][:reportsize] = folders.size

  @host    = host
  @folders = folders

  domain   = MAILMAPPING[host]
  hostpart = host.split(".")
  if hostpart.size > 1
    domain ||= hostpart[-2..-1].join(".")
  else
    domain ||= host
  end
  mail     = "security@#{domain}"
  
  renderer = ERB.new(template)
  text     = renderer.result()

  `sendmail -f #{SENDER} #{mail} <<EOF
#{text}
EOF`
end

f = File.open(db_file,'w',0600)
f.write(db.to_yaml)
f.close
